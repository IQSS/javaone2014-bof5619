<!DOCTYPE html>
<html>
  <head>
    <title>BOF5619 Lean Beans (are made of this): Command pattern vs. MVC</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(http://fonts.googleapis.com/css?family=Architects+Daughter);
      @import url(http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      /* Two-column layout */
      /*
      .left-column {
        color: #777;
        width: 20%;
        height: 92%;
        float: left;
      }
        .left-column h2:last-of-type, .left-column h3:last-child {
          color: #000;
        }
      .right-column {
        width: 75%;
        float: right;
        padding-top: 1em;
      }
      */
      .bigfont {
        font-size: 2em;
      }
      .regularfont {
        font-size: .7em;
      }
      .btw {
        font-size: .65em;
        color: #444;
      }
  
      .deleted {
        text-decoration: line-through;
      }

      .bottom-remark {
        font-size: 0.5em;
        color: gray;
        position: absolute;
        bottom: 1em;
        left: 0;
        right: 0;
      }

      .slide-badge {
        position: absolute;
        right: 20px;
        top: 20px;
        border: 1px black solid;
        -ms-transform: rotate(-7deg); /* IE 9 */
        -webkit-transform: rotate(-7deg); /* Chrome, Safari, Opera */
        transform: rotate(-7deg);
      }
      .slide-emph-max {
        color: white;
        background-color: black;
      }
      .slide-emph-mid {
        background-color: #00d56b;
      }
      
      .speech {
        background-color: white;
        border-radius: 1em 1em 1em 0.2em;
        padding: 0.5em;
        border: 1px black solid;
        box-shadow: 0 2px 4px rgba(0,0,0,.5);
        font-family: 'Architects Daughter';
      }

      /* from http://nicolasgallagher.com/pure-css-speech-bubbles/demo/ */
      .example-obtuse {
        position:relative;
        padding:15px 30px;
        margin:0;
        color:#000;
        background:#f3961c; /* default background for browsers without gradient support */
        /* css3 */
        background:-webkit-gradient(linear, 0 0, 0 100%, from(#f9d835), to(#f3961c));
        background:-moz-linear-gradient(#f9d835, #f3961c);
        background:-o-linear-gradient(#f9d835, #f3961c);
        background:linear-gradient(#f9d835, #f3961c);
        /* Using longhand to avoid inconsistencies between Safari 4 and Chrome 4 */
        -webkit-border-top-left-radius:25px 50px;
        -webkit-border-top-right-radius:25px 50px;
        -webkit-border-bottom-right-radius:25px 50px;
        -webkit-border-bottom-left-radius:25px 50px;
        -moz-border-radius:25px / 50px;
        border-radius:25px / 50px;
      }

      /* display of quote author (alternatively use a class on the element following the blockquote) */
      .example-obtuse + p {margin:10px 150px 2em 0; text-align:right; font-style:italic;}

      /* creates the larger triangle */
      .example-obtuse:before {
        content:"";
        position:absolute;
        bottom:-30px;
        right:80px;
        border-width:0 0 30px 50px;
        border-style:solid;
        border-color:transparent #f3961c;
        /* reduce the damage in FF3.0 */
        display:block;
        width:0;
      }

      /* creates the smaller triangle */
      .example-obtuse:after {
        content:"";
        position:absolute;
        bottom:-30px;
        right:110px;
        border-width:0 0 30px 20px;
        border-style:solid;
        border-color:transparent #fff;
        /* reduce the damage in FF3.0 */
        display:block;
        width:0;
      }

      blockquote {
          margin: 1em 0px;
      }



    </style>
  </head>
  <body>
    <textarea id="source">

class: bottom

# BOF5619 - Lean Beans (are made of this): Command pattern vs. MVC

<img src="images/michbarsinai.jpg" width="60" align="left" style="border:5px solid transparent" />
Michael Bar-Sinai ([@michbarsinai](https://twitter.com/michbarsinai))  
http://www.iq.harvard.edu/people/michael-bar-sinai  
http://mbarsinai.com

<img src="images/philipdurbin.jpg" width="60" align="left" style="border:5px solid transparent" />
Philip Durbin ([@philipdurbin](https://twitter.com/philipdurbin))  
http://www.iq.harvard.edu/people/philip-durbin  
http://greptilian.com

.right[[![IQSS logo](images/iqss-logo.png)](http://www.iq.harvard.edu)]

???

Hello! Thanks for coming. Let's get going.

This is Birds Of A Feather 5619, "Lean Beans (are made of this): Command pattern vs. MVC."

We are Michael Bar-Sinai and Philip Durbin, developers at the Institute for Quantitative Social Science at Harvard University. That's IQSS on GitHub.

---

class: bigfont

# Agenda

1. Intro
2. MVC, Java EE MVC, Classic command
3. Command Adaptation for modern Java EE
  * With real-world examples!
4. The Lean Beans Design Pattern

TODO
* Should briefly summarize the benefit to Dataverse early in the talk (GUI and API use same commands, enforcing permissions with annotations on commands) before we define MVC, etc.

.regularfont[
Slides and code:

https://github.com/IQSS/javaone2014-bof5619
]

???

Here's the agenda for this talk.

First off, don't let the little crimson logo confuse you. We will not be talking about is not an academic exercise, but rather applying the command pattern to a real-world application called "Dataverse". There are several installations of it, the one at Harvard housing the world's largest collection of social datasets (about 749 thousand files for 54 thousand datasets). You can fork it on GitHub.

First, we'll talk briefly about classic MVC, MVC in Java EE, and the classic command pattern.

Then, we'll present the adjustments we've made to the command pattern to adapt it to Java EE, modern programming and a permission-based system.

By way of example, we're going to show how we adjusted the command pattern our Dataverse application.

Finally, we'll generalize the lessons learned and explain why we refer to the pattern as the "Lean Beans Design Pattern."

This entire talk, including the code, has already been posted to GitHub. You should be able to find it under github.com/IQSS and you should feel free to open issues.

---

# Classic MVC

Goal: <strong>Separate data from its representation</strong>
- Model: Business objects
- View: What the users sees and interacts with
- Controller: Manipulates the model according to inputs from the view

.center[
  <img src="uml/mvc.svg" width="350"/>
]
<!-- <img src="images/gof.png" width="300"/>
<img src="images/hfdp.jpg" width="300"/>
 -->
???

In classic MVC:
  * the model consists of business objects - pure concepts implemented in your language of choice, 
  * the view is what the user sees and interacts with, 
  * and the controller is manipulates the model. 

MVC separates the user interactions from the data. This proved to be a clean way that also facilitates reuse.

This pattern was developed by Trygve Reenskaug, while visiting Xerox PARC in '79 working on graphical user interfaces using SmallTalk. It's interesting to note that it is _not_ part of the GoF patterns.

The main benefit here is that the model can be viewed in many ways without cluttering it and views can possibly be used to display different models.

---
# The Command Pattern
.slide-badge[
  <img src="images/gof.png" width="100">
]

Goal: <strong>Capture operations on the model as data</strong>

.center[
  <img src="uml/mvcc.svg" width="450"/>
]
???

Presented in the classic GoF book, this pattern captures modifications to the model objects as data.

---

class: bigfont

# Official GoF definition

<img src="images/gof.png" width="300" align="right"/>

The Command Pattern encapsulates a request as an object, thereby letting you parameterize other objects with different requests, queue or log requests, and support undoable operations.

Objects in play: Client, Command, Receiver, and Invoker

???

---

class: bigfont

# Waitresses and Cooks

<img src="images/hfdp.jpg" width="400" align="right"/>

- Customer
- Order
- Waitress
- Cook

???

In Head First Design Patterns you'll see the client is a customer at a diner, who makes an order, which is the command, that goes to the waitress, who is the "invoker", who gives it to the cook, who is the "receiver". 

Then they talk about a remote control with buttons you can program, all using the command pattern.

---

# You Are In Command Now

(Admiral Piett)

<img src="images/in-command-now.jpg" width="600"/>

???

I don't wanna talk about cooks and waitresses so I'm going to give you some examples from Star Wars.

Let's say you're Darth Vader and you've got a whole empire to command. You're forever giving these guys commands.

---

class: bigfont

# Giving Commands

<img src="images/look-sir-droids.jpg" width="400"/>

1. stop people with droids
1. check identification

???

So you start out by telling them:

- look around for some droids and
- for the people that are with the droids... check their identification

Should be a piece cake. How hard could this be?

---

# The Command supertype
.center[
  <img src="images/not-the-droids.png" width="600"/>
]

```java

public interface Command {
    void execute();
}

```

???

Let's first look at a Command object. Notice that it's an interface. Individual commands will implement this interface.

(Technically, you don't have to use the `interface` keyword; It can be any class.)

Notice that the command interface is very simple. It only requires that you implement a single method, which is often called `execute()`.

That's some of the power of the dark side... er, power of the command pattern... that no matter what the command is called, the complexity is hidden behind a consistently named method such as "execute".

---
layout: true
.slide-badge[
  <img src="images/not-the-droids.png" width="200"/>
]
---

# Complete CheckIdCommand

```java
public class CheckIdCommand implements Command {

    private Suspect suspect;

    public CheckIdCommand(Suspect suspect) {
        this.suspect = suspect;
    }

    public void execute() {
        try {
            System.out.println("Id for " + suspect.getName() 
                                    + " is " + suspect.getId());
        } catch (Exception ex) {
            System.out.println("Move along, move along.");
        }
    }

}

```

???

Here's the full `CheckIdCommand` example.

Notice that a suspect gets passed into the constructor of the command. In this case the suspect is Obiwan Kenobe so there's the danger of a JediMindTrick exception being thrown.

Perhaps unwisely, if any exception is thrown at all, the stormtrooper simply says, "Move along, move along."

That's all contained in the execute() method, which again is required by the command interface. All commands have an execute() method.

---

# The Client

- command bound to receiver
- invoker is given a command to execute, and told to execute it

```java
System.out.println("# Mos Eisley checkpoint");

StormTrooper stormTrooper = /* Recruit trooper here */
Suspect obiwan = new Jedi("Obiwan"); // receiver
Command checkIdCommand = new CheckIdCommand(obiwan);

stormTrooper.setCommand( checkIdCommand ); // invoker
*stormTrooper.execute(); // Move along, move along.
```

???

In the command pattern the client is the piece ties it everything together. We'll see all of the components in play.

Before we instantiate our CheckIdCommand, we need to decide which Suspect we're going to bind it to. Whose id are we going to check? A Jawa? A Tuskan Raider? No... we've got Obiwan here, so he's what gets passed in when we create the command. Obiwan is the "receiver" of the command.

And who's going to execute the CheckIdCommand? The stormtrooper. 

Of course, when we call execute that stupid JediMindTrick exception gets thrown so we just say, "We don't need to see his identification." 

---

# One Invoker, Two Commands
same stormtrooper given different commands

```java
StormTrooper stormTrooper = /* Recruit trooper here */

System.out.println("# Mos Eisley checkpoint");
Suspect obiwan = new Jedi("Obiwan"); // receiver
*Command checkIdCommand = new CheckIdCommand(obiwan);
stormTrooper.setCommand(checkIdCommand);
stormTrooper.execute(); // Move along, move along.

System.out.println("# Death Star hangar");
Ship falcon = new Ship("Millenium Falcon"); // receiver
*Command checkShipCommand = new CheckShipCommand(falcon);
stormTrooper.setCommand(checkShipCommand); // same invoker, new command
stormTrooper.execute(); // No one on board.
```

---

# Stormtrooper/Invoker

```java
public class StormTrooper {

    private Command command;

    public StormTrooper(Command command) {
        this.command = command;
    }

    public void setCommand(Command command) {
        this.command = command;
    }

    public void execute() {
        command.execute();
    }

}

```

???

This adheres to the classic 1994 book implementation - note the statefulness, where you first set a field and then use another call to request the invoker to invoke the command.

---

# Suspect/Receiver

```java
public class Suspect {
    // fields, constructors, getters

    public String getId() {
        return id;
    }
}
```

Jedi were always in a class of their own.

```java
public class Jedi extends Suspect {
  
    @Override
    public String getId() {
      throw new RuntimeException("Jedi mind trick!");
    }
}
```

---

# Another Command Example


```java
public class CheckShipCommand implements Command {

    Ship ship;

    public CheckShipCommand(Ship ship) {
        this.ship = ship;
    }

    public void execute() {
        System.out.println( 
            ship.getSuspects().isEmpty() ? "No one on board." 
                    : "Found " + ship.getSuspects().size() 
                                 + " suspects in " + ship.getName());
    }

}
```

---

<h1>Star Wars Class Diagram</h1>

.center[
  <img src="uml/starwars.svg" width="500"/>
]

???

---
layout: true

---

class: middle center slide-emph-mid

#But what's in it for us?
.left[
* Why not call `execute()` on the command from the client code?
* Why not put the functionality of `execute()` in a normal function instead of creating new objects?
* _Yet another_ level of indirection? Don't we have enough of these?
]
---
# Code as Data
The command pattern allows us to treat code blocks as data. So we can:
- Reuse actions from different controllers
- Store commands in data structures
  - Queue commands
  - Map keys to commands (events triggering actions)
- Execute on a different thread
    - Plays well with serialization
- Execute macros, as sequence of commands
- When commands can invoke commands - we get full recursive-ness
- Test better
- Log better
- Easy extend to support undo and command history

We can do all this (and more!) with commands.

.right[But there's one very special thing we can also do...]

???

So, really - we take a block of code and its parameters, an use it as a data (think of storing commands in a Map, where the key is an event id - for triggered command execution). What's another version of this? Right, lambda expressions. This is fundamentally different from the traditional procedural Code/Data dichotomy.
---
class: middle center slide-emph-max
.bigfont[ Ignore Them. ]

???
Why would we like to ignore commands? Maybe, if the user that issued them does not have a permission to do so (you can't disable buttons when you write an API). Or maybe they make no sense.

---
# Why We Chose Command

For Dataverse 4.0, a Java EE 7 app which needs to support sensitive data and a full API, we wanted:
* Maximal code re-use between the API and the UI
* By-design, permission-based security.

.center[ <img src="images/dvn4.png" alt="">]


With some extensions and infrastructure (shown later) - we got just that.

---

# Back on schedule

<blockquote class="example-obtuse">
  <p style="font-size:1.4em;">You may dispense with the pleasantries, Commander. I'm here to put you back on schedule.</p>
</blockquote>

<img src="images/schedule.jpg" width="600"/>

???

Of course, Darth Vader doesn't care about all this. He just wants you to build the Death Star! On schedule!

---

# Back to Java EE

.middle.center[
  <img src="images/deathstar-gf.png" width="500"/>
]

???

Did you know that all the software that powers the Death Star is written in Java EE? It's true!

Ok, they slipped some Python in there too.

But you know, Darth Vader doesn't know (or care) but since we're talking about Java EE, let see how we can start to apply the command pattern to it.

---

# MVC in Java EE

Balancing clean design and practicality.
.center[
  <img src="uml/mvc-ee.svg" width="500">
]

.btw[
 Note: We show one interpretation here - there are other interpretations as well.
]

???

Let's move on the MVC in Java EE. Not as clean, but handles persistence and handles the complexities of a GUI over stateless protocol such as HTTP.

We've drown the lines between the boxes, other people would probably place them differently.

Also note that some annotations, such as the validation ones, go against this separation by adding user interface texts to the model objects (e.g `@NotBlank(message = "Please enter an identifier for your dataset.")`)

---
# MVC in Java EE

Balancing clean design and practicality.
.center[
  <img src="uml/mvc-ee.svg" width="500">
]
.btw[
 Note: We show one interpretation here - there are other interpretations as well.
]

<div style="position: absolute; top:140px; left: 230px" class="speech">Now, how do I cram <strong>Command</strong> in here?</div>
<div style="position: absolute; top:180px; left: 230px">/</div>

---
class: middle center

<img src="images/disturbance.png" />
---
<!--
Michael edited up to here
-->


# Nothing New Under The Sun

EJB Design Patterns: Advanced Patterns, Processes, and Idioms by Floyd Marinescu, 2002

<img src="images/ejb-design-patterns.jpg" width="300" align="right"/>

*4.5 stars on Amazon from 37 reviews*

"Use the Command pattern to wrap business logic in lightweight command beans that decouple the client from EJB, execute in one network call, and act as a façade for the EJB layer." (p. 19)

- Session Façade + Business Delegate vs. Command
- Command Server (invoker) as stateless session bean

http://www.theserverside.com/news/1369776/Free-Book-EJB-Design-Patterns

???

So! Is my group the first to apply the command pattern to Java EE? Of course not.

In 2002 (12 years ago!) Floyd Marinescu wrote a book called "EJB Design Patterns" that said,

- "Use the Command pattern to wrap business logic in lightweight command beans that decouple the client from EJB, execute in one network call, and act as a façade for the EJB layer."

He frames the Command pattern as an alternative to a combination of the Session Façade pattern and the Business Delegate pattern.

He doesn't seem to use the term "invoker" but to him it's the "command server". He says,

- "Applied to EJB, the Command Server class is a stateless session bean that accepts a command as a parameter and executes it locally."

---

# Merging Java EE and Commands

* TODO present the mvcc-ee
  * our command
    - modern touches (not stateless, but with less state, generics )
    - Context, so no dependency injection needed (pojo)
      - Testability using JUnit!
    - Metadata
      - Permission Annotations
      - user
      - Receiver of a given type (DvObject)


???

---

# Dataverse 4.0: more granular permissions 

Command pattern examples:

- CreateDatasetCommand
- PublishDatasetCommand
- DeleteDataFileCommand
- Reuse: get latest draft/published/accessible version

???

Back to Dataverse, which again is the app we work on.

One of the main areas where we wanted more flexibility was in our system for permissions.

---

# Dataverse Commands

<img src="images/dataverse-classes.png" width="500" align="right"/>

- EjbDataverseEngine as "invoker" or "Command Server"
- Service beans part of command context
- Commands annotated with required permissions

???

- adjusted and simplified from actual code
- EjbDataverseEngine is the invoker
- service beans are the receivers (nearly all available in CommandContext)
- PermissionException thrown if user lacks sufficient permission
- IllegalCommandException thrown if command doesn't make sense (publish something that's already published)

---

# More on Dataverse Commands

- Permission annotations
    - Dealing with inheritance
- Permission sets as bit fields.
- Testability (demo junit code)
- Resuability (demo backing bean/api code)
- Decorators
- Decorator collides with annotations, so we use static/dynamic combo

---

# Implementation Points

- Permission are an enum, stored as bit field in the DB (long)
  - no joins, bitwise tests.
- Static vs Dynamic permission lists. Can't support e.g. Decorator. Considering a static/dynamic approach to support this
  - maybe implemented by then??

---

# Lean Beans Design Pattern
- traditional JavaEE uses service beans to modify models
- We use commands
- &rarr; Can we get rid of service beans? would that be wise?
- business logic goes in commands
- service beans do basic CRUD

---

# Can we replace beans with commands?

- Not entirely, due to dependency injections etc.
- We can replace everything except `EntityManager`s, JMS queue pools etc.

---

# More on the command pattern

- https://github.com/IQSS/dataverse
- https://github.com/bethrobson/Head-First-Design-Patterns/tree/master/src/headfirst/designpatterns/command (Java 8!)
- http://gameprogrammingpatterns.com/command.html
- http://www.vincehuston.org/dp/command.html
  - http://www.vincehuston.org/dp/CommandDemosJava
- http://education.oracle.com/pls/web_prod-plq-dad/db_pages.getCourseDesc?dc=D61858GC10
- http://www.corej2eepatterns.com/ApplicationController.htm
- http://www.corej2eepatterns.com/FrontController.htm
- https://www.nofluffjuststuff.com/conference/seattle/2005/10/session?id=1278
- http://www.journaldev.com/1624/command-design-pattern-in-java-example-tutorial
- https://www.youtube.com/watch?v=o8Iw75nboJY
- http://javapapers.com/design-patterns/command-design-pattern/
- http://iqss.github.io/javaone2014-bof5619 (sample code from this talk)

---
class: middle center

#Thanks

.bottom-remark[
Presentation created using remark.js. UML drawings done with PlantUML.
]
    </textarea>
    <script src="js/remark-0.6.5.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>
