<!DOCTYPE html>
<html>
  <head>
    <title>BOF5619 Lean Beans (are made of this): Command pattern vs. MVC</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      /* Two-column layout */
      .left-column {
        color: #777;
        width: 20%;
        height: 92%;
        float: left;
      }
        .left-column h2:last-of-type, .left-column h3:last-child {
          color: #000;
        }
      .right-column {
        width: 75%;
        float: right;
        padding-top: 1em;
      }
      .bigfont {
        font-size: 2em;
      }
      .regularfont {
        font-size: .7em;
      }

      /* from http://nicolasgallagher.com/pure-css-speech-bubbles/demo/ */
      .example-obtuse {
        position:relative;
        padding:15px 30px;
        margin:0;
        color:#000;
        background:#f3961c; /* default background for browsers without gradient support */
        /* css3 */
        background:-webkit-gradient(linear, 0 0, 0 100%, from(#f9d835), to(#f3961c));
        background:-moz-linear-gradient(#f9d835, #f3961c);
        background:-o-linear-gradient(#f9d835, #f3961c);
        background:linear-gradient(#f9d835, #f3961c);
        /* Using longhand to avoid inconsistencies between Safari 4 and Chrome 4 */
        -webkit-border-top-left-radius:25px 50px;
        -webkit-border-top-right-radius:25px 50px;
        -webkit-border-bottom-right-radius:25px 50px;
        -webkit-border-bottom-left-radius:25px 50px;
        -moz-border-radius:25px / 50px;
        border-radius:25px / 50px;
      }

      /* display of quote author (alternatively use a class on the element following the blockquote) */
      .example-obtuse + p {margin:10px 150px 2em 0; text-align:right; font-style:italic;}

      /* creates the larger triangle */
      .example-obtuse:before {
        content:"";
        position:absolute;
        bottom:-30px;
        right:80px;
        border-width:0 0 30px 50px;
        border-style:solid;
        border-color:transparent #f3961c;
        /* reduce the damage in FF3.0 */
        display:block;
        width:0;
      }

      /* creates the smaller triangle */
      .example-obtuse:after {
        content:"";
        position:absolute;
        bottom:-30px;
        right:110px;
        border-width:0 0 30px 20px;
        border-style:solid;
        border-color:transparent #fff;
        /* reduce the damage in FF3.0 */
        display:block;
        width:0;
      }

      blockquote {
          margin: 1em 0px;
      }



    </style>
  </head>
  <body>
    <textarea id="source">

class: bottom

# BOF5619 - Lean Beans (are made of this): Command pattern vs. MVC

Philip Durbin ([@philipdurbin](https://twitter.com/philipdurbin))  
http://www.iq.harvard.edu/people/philip-durbin  
http://greptilian.com

.right[[![IQSS logo](images/iqss-logo.png)](http://www.iq.harvard.edu)]

???

Hello! Thanks for coming. Let's get going.

This is Birds Of A Feather 5619, "Lean Beans (are made of this): Command pattern vs. MVC."

My name is Philip Durbin and I'm developer at the Institute for Quantitative Social Science at Harvard University. That's IQSS on GitHub.

---

class: bigfont

# Agenda

1. Why
1. What
1. How

.regularfont[
Slide and code:

https://github.com/IQSS/javaone2014-bof5619
]

???

The agenda for this talk is pretty simple:

- Why
- What
- How
- Whither

I'm going to talk a bit about how my team came to adopt the command pattern before diving down into what it is... with plenty of code samples.

I've been to a few talks by Arun Gupta and he always says, "Code is king," and I just love that. So the code is coming. Relax.

And... this entire talk, including the code, has already been posted to GitHub.

You should be able to find it under github.com/IQSS

You're welcome to open issues on the GitHub repo... and right now, during this talk, please feel free to raise your hand and stop me.

---

# Dataverse

Dataverse is an open source web application for sharing, citing, analyzing, and preserving research data.

Began life (under the name Dataverse) as a Java EE 5 application in 2006.


Dataverse 4.0 ( https://github.com/IQSS/dataverse ) is a complete rewrite:

- more flexible architecture
- focus on usability
- ... much more! (See http://dataverse.org for details.)

???

So! Why... why am I talking about the command pattern at all?

You see, I work on an open source project called Dataverse that began life in 2006 (under that name anyway) as a Java EE 5 application.

About a year ago, shortly after last year's JavaOne, we started talking about the possibility of re-writing Dataverse from the ground up.

Our users were finding the application very useful but they wanted more flexibility in a variety of areas.

---

# Dataverse 4.0: more granular permissions 

Command pattern examples:

- CreateDatasetCommand
- PublishDatasetCommand
- DeleteDataFileCommand
- ...

Idea to use command pattern came from one of our architects:

Michael Bar-Sinai ([@michbarsinai](https://twitter.com/michbarsinai))  
http://www.iq.harvard.edu/people/michael-bar-sinai  
http://mbarsinai.com/blog

???

One of the main areas where we wanted more flexibility was in our system for permissions.

A very bright colleague of mine, Michael Bar-Sinai, came up with the initial design, which is based on the command pattern.

Here we see a few example commands:

- CreateDatasetCommand
- PublishDatasetCommand
- DeleteDataFileCommand
- and so on

---

# The Command Pattern

<!-- <blockquote class="rectangle-speech-border"> -->
<img src="images/in-command-now.jpg" width="600"/>
<blockquote class="example-obtuse">
  <p style="font-size:1.7em;">You are in command now, Admiral Piett.</p>
</blockquote>

???

Lemme back up minute though.

"Command pattern" is in the title of this talk so I know you've *heard* of it, but how many people here have actually used the command pattern?

---

# Learning the Command Pattern

<img src="images/gof.png" width="300"/>
<img src="images/hfdp.jpg" width="300"/>

???

I'm relatively new to the command pattern myself. My first introduction to it was working with the code that Michael put in our app but I found it very useful to read through the command pattern chapter in Head First Design Patterns. That's this book on the right.

In that book you'll see the client is a customer at a diner, who makes an order, which is the command, that goes to the waitress, who is the "invoker", who gives it to the cook, who is the "receiver". 

Then they talk about a remote control with buttons you can program, all using the command pattern. It's very well done. It's a great book.

And of course, you can't talk about a design pattern without mentioning the Gang Of Four book here on the left. I haven't read it but I've heard good things.

---

class: bigfont

# Giving Commands

<img src="images/look-sir-droids.jpg" width="400"/>

1. stop people with droids
1. check identification

???

I don't wanna talk about cooks and waitresses so I'm going to give you some examples from Star Wars.

Let's say you're Darth Vader and you've got an army of troops. You're forever giving these guys commands.

So you start out by telling them:

- look around for some droids and
- for the people that are with the droids... check their identification

---

# CheckIdCommand and supertype

<img src="images/not-the-droids.png" width="600"/>

```java
public class CheckIdCommand implements Command {
    // coming soon!
}

public interface Command {

    void execute();

}

```

???

So! You've got this CheckIdCommand.

The first thing to notice is that the individual commands always implements the command interface.

(Technically, it doesn't have to be a Java interface; it can be an abstract class.)

Notice that the command interface is very simple. It only requires that implement a single command, which is often called `execute()`.

---

# Complete CheckIdCommand

<img src="images/not-the-droids.png" width="200"/>

```java
public class CheckIdCommand implements Command {

    private Suspect suspect;

    public CheckIdCommand(Suspect suspect) {
        this.suspect = suspect;
    }

    public void execute() {
        try {
            System.out.println("Id for " + suspect + " is " + suspect.getId());
        } catch (Exception ex) {
            System.out.println("Move along, move along.");
        }
    }

}

```

???

Here's the full `CheckIdCommand` example.

Notice that a suspect gets passed into the constructor. In this case the suspect is Obiwan Kenobe so there's the danger of a JediMindTrick exception being thrown.

Perhaps unwisely, if any exception is thrown at all, the stormtrooper simply says, "Move along, move along."

That's all contained in the execute() method, which again is required by the command interface.

---

# The Client

<img src="images/not-the-droids.png" width="200"/>


```java
System.out.println("# Mos Eisley checkpoint");
Suspect obiwan = new Suspect("Obiwan", Suspect.Type.JEDI);
Command checkIdCommand = new CheckIdCommand(obiwan);
StormTrooper stormTrooper = new StormTrooper(checkIdCommand);
stormTrooper.execute(); // Move along, move along.

System.out.println("# Death Star hangar");
Ship falcon = new Ship("Millenium Falcon", Ship.Type.SMUGGLING);
Command checkShipCommand = new CheckShipCommand(falcon);
stormTrooper.setCommand(checkShipCommand);
stormTrooper.execute(); // No one on board.
```

- commands are bound to objects (suspects, ships)
- same stormtrooper given a new command with setCommand()

???

Here we finally get the whole picture.

In both cases, the stormtrooper simply calls execute() to execute the command, no matter if it's the CheckIdCommand or the CheckShipCommand.

---

class: bigfont

# Official definition from the Gang of Four

The Command Pattern encapsulates a request as an object, thereby letting you parameterize other objects with different requests, queue or log requests, and support undoable operations.

---

class: bigfont

# Definining the command pattern

- command
- receiver
- invoker
- client

--

An example from http://en.wikipedia.org/wiki/Command_pattern

---

.left-column[
  ## Four terms
  ### - command
]
.right-column[

# command

A command object has a receiver object and invokes a method of the receiver in a way that is specific to that receiver's class. 

```java
/* The Command interface */
public interface Command {
   void execute();
}
 
/* Command for turning on light - ConcreteCommand #1 */
public class FlipUpCommand implements Command {
   private Light theLight;
 
   public FlipUpCommand(Light light) {
      this.theLight = light;
   }
 
   public void execute(){
      theLight.turnOn();
   }
}
```

]

---

.left-column[
  ## Four terms
  ### - command
  ### - receiver
]
.right-column[

# receiver

The receiver may be called the target. It does the work.

```java
/* The Receiver class */
public class Light {
 
   public void turnOn() {
      System.out.println("The light is on");
   }
 
   public void turnOff() {
      System.out.println("The light is off");
   }
}
```

]

---

.left-column[
  ## Four terms
  ### - command
  ### - receiver
  ### - invoker
]
.right-column[

# invoker

The invoker invokes the command and optionally does bookkeeping about the command execution.

```java
/* The Invoker class */
public class Switch {
   private List<Command> history = new ArrayList<Command>();
 
   public void storeAndExecute(Command cmd) {
      this.history.add(cmd); // optional 
      cmd.execute();        
   }
}
```

]

---

.left-column[
  ## Four terms
  ### - command
  ### - receiver
  ### - invoker
  ### - client
]
.right-column[

# client

The client contains the decision making about which commands to execute at which points.

```java
/* The test class or client */
public class PressSwitch {
   public static void main(String[] args){
      Light lamp = new Light();
      Command switchUp = new FlipUpCommand(lamp);
      Command switchDown = new FlipDownCommand(lamp);
 
      Switch mySwitch = new Switch();
 
      switch(args[0]) {
         case "ON":
            mySwitch.storeAndExecute(switchUp);
         break;
         case "OFF":
            mySwitch.storeAndExecute(switchDown);
         break;
         default:
            System.out.println("ON or OFF?");
       }
   }
}
```

]

---

# Back on schedule

<blockquote class="example-obtuse">
  <p style="font-size:1.4em;">You may dispense with the pleasantries, Commander. I'm here to put you back on schedule.</p>
</blockquote>

<img src="images/schedule.jpg" width="600"/>

---

# More on the command pattern

- https://github.com/bethrobson/Head-First-Design-Patterns/tree/master/src/headfirst/designpatterns/command (Java 8!)
- http://gameprogrammingpatterns.com/command.html
- http://www.vincehuston.org/dp/command.html
  - http://www.vincehuston.org/dp/CommandDemosJava
- http://iqss.github.io/javaone2014-bof5619 (sample code from this talk)

    </textarea>
    <script src="js/remark-0.6.5.min.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>
